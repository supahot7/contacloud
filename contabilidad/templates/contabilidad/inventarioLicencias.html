{% extends 'base.html' %} {% load static %} {% block title %}Inventario de
Licencias - ContaCloud{% endblock %} {% block content %}
<link
  rel="stylesheet"
  href="{% static 'css/contabilidad/inventarioLicencias.css' %}"
/>

<div class="container py-4">
  <!-- Encabezado -->
  <header class="header-section text-center mb-4">
    <h1>Inventario de Licencias</h1>
    <p>Gestión del inventario de licencias del sistema</p>
  </header>

  <!-- Tarjetas de resumen -->
  <section class="summary-cards" aria-label="Resumen de inventario">
    <div class="summary-grid">
      <div class="summary-card">
        <strong class="card-label">Total de Licencias</strong>
        <span class="card-value" id="totalLicencias">0</span>
      </div>
      <div class="summary-card">
        <strong class="card-label">Unidades Disponibles</strong>
        <span class="card-value" id="unidadesDisponibles">0</span>
      </div>
      <div class="summary-card">
        <strong class="card-label">Valor Total de Inventario $</strong>
        <span class="card-value" id="valorTotal">$0.00</span>
      </div>
    </div>
  </section>

  <!-- Barra de búsqueda y acciones -->
  <section class="search-section" aria-label="Búsqueda y acciones">
    <div class="search-wrapper">
      <div class="search-input-group">
        <label for="buscar" class="search-label"
          ><strong>Buscar por:</strong></label
        >
        <input
          type="text"
          id="buscar"
          name="buscar"
          class="search-input"
          placeholder="Buscar por nombre o código"
          aria-label="Campo de búsqueda"
        />
      </div>
      <button
        type="button"
        class="btn-primary btn-new"
        id="btnNuevaLicencia"
        aria-label="Agregar nueva licencia"
      >
        <span class="btn-icon">+</span>
        <span class="btn-text">Nueva Licencia</span>
      </button>
    </div>
  </section>

  <!-- Tabla de datos -->
  <section class="table-section" aria-label="Tabla de licencias">
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th scope="col">Código</th>
            <th scope="col">Nombre</th>
            <th scope="col">Descripción</th>
            <th scope="col">Fecha</th>
            <th scope="col">Cantidad Disponible</th>
            <th scope="col">Precio Unitario</th>
            <th scope="col">Valor Total</th>
            <th scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody id="tableLicencias">
          <tr>
            <td
              colspan="8"
              style="text-align: center; padding: 2rem; color: #6c757d"
            >
              No hay licencias registradas. Haz clic en "Nueva Licencia" para
              agregar una.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Botón de guardar -->
  <footer class="footer-actions text-center">
    <button
      type="button"
      class="btn-primary btn-save"
      id="btnGuardar"
      aria-label="Guardar cambios"
    >
      Guardar
    </button>
  </footer>
</div>

<!-- Modal para agregar/editar licencia -->
<div id="modalLicencia" class="modal-overlay" style="display: none">
  <div class="modal-container">
    <div class="modal-header">
      <h2 id="modalTitulo">Nueva Licencia</h2>
      <button type="button" class="modal-close" id="btnCerrarModal">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="formLicencia">
        <div class="form-group">
          <label for="codigo">Código</label>
          <input type="text" id="codigo" class="form-control" readonly />
        </div>

        <div class="form-group">
          <label for="nombre">Nombre <span class="required">*</span></label>
          <input
            type="text"
            id="nombre"
            class="form-control"
            placeholder="Ej: Licencia Básica"
            required
          />
        </div>

        <div class="form-group">
          <label for="descripcion">Descripción</label>
          <textarea
            id="descripcion"
            class="form-control"
            rows="3"
            placeholder="Descripción de la licencia"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="fecha">Fecha</label>
          <input type="date" id="fecha" class="form-control" required />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="cantidad"
              >Cantidad Disponible <span class="required">*</span></label
            >
            <input
              type="number"
              id="cantidad"
              class="form-control"
              min="0"
              value="0"
              required
            />
          </div>

          <div class="form-group">
            <label for="precio"
              >Precio Unitario <span class="required">*</span></label
            >
            <input
              type="number"
              id="precio"
              class="form-control"
              min="0"
              step="0.01"
              value="0.00"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="valorTotal">Valor Total</label>
          <input type="text" id="valorTotal" class="form-control" readonly />
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" id="btnCancelar">
        Cancelar
      </button>
      <button type="button" class="btn-primary" id="btnGuardarLicencia">
        Guardar Licencia
      </button>
    </div>
  </div>
</div>

<style>
  /* ==============================
   Estilos del Modal
   ============================== */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .modal-container {
    background-color: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #dee2e6;
    background-color: #007b80;
    color: #fff;
    border-radius: 0.5rem 0.5rem 0 0;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: #fff;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 30px;
    height: 30px;
  }

  .modal-close:hover {
    opacity: 0.8;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid #dee2e6;
  }

  /* ==============================
   Formulario
   ============================== */
  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
  }

  .form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    font-size: 1rem;
    transition: border-color 0.2s ease;
  }

  .form-control:focus {
    outline: none;
    border-color: #007b80;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 128, 0.25);
  }

  .form-control:read-only {
    background-color: #e9ecef;
    cursor: not-allowed;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .required {
    color: #dc3545;
  }

  /* ==============================
   Botones del modal
   ============================== */
  .btn-secondary {
    background-color: #6c757d;
    border: none;
    color: #fff;
    padding: 0.5rem 1.5rem;
    border-radius: 0.25rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-secondary:hover {
    background-color: #5a6268;
  }

  @media (max-width: 768px) {
    .modal-container {
      width: 95%;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // ==============================
  // Variables globales
  // ==============================
  let licencias = [];
  let contadorCodigo = 1;
  let indiceEdicion = -1;

  // ==============================
  // Función para calcular totales
  // ==============================
  function calcularTotales() {
    const totalLicencias = licencias.length;
    const unidadesDisponibles = licencias.reduce(
      (sum, lic) => sum + parseInt(lic.cantidad),
      0
    );
    const valorTotal = licencias.reduce(
      (sum, lic) => sum + parseFloat(lic.valorTotal),
      0
    );

    document.getElementById("totalLicencias").textContent = totalLicencias;
    document.getElementById("unidadesDisponibles").textContent =
      unidadesDisponibles;
    document.getElementById("valorTotal").textContent = `$${valorTotal.toFixed(
      2
    )}`;
  }

  // ==============================
  // Función para renderizar la tabla
  // ==============================
  function renderizarTabla() {
    const tbody = document.getElementById("tableLicencias");

    if (licencias.length === 0) {
      tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 2rem; color: #6c757d;">
          No hay licencias registradas. Haz clic en "Nueva Licencia" para agregar una.
        </td>
      </tr>
    `;
      return;
    }

    tbody.innerHTML = licencias
      .map(
        (licencia, index) => `
    <tr>
      <td data-label="Código">${licencia.codigo}</td>
      <td data-label="Nombre">${licencia.nombre}</td>
      <td data-label="Descripción">${licencia.descripcion}</td>
      <td data-label="Fecha">${licencia.fecha}</td>
      <td data-label="Cantidad Disponible">${licencia.cantidad}</td>
      <td data-label="Precio Unitario">$${parseFloat(licencia.precio).toFixed(
        2
      )}</td>
      <td data-label="Valor Total">$${parseFloat(licencia.valorTotal).toFixed(
        2
      )}</td>
      <td data-label="Acciones" class="actions-cell">
        <div class="action-buttons">
          <button
            type="button"
            class="btn-action btn-edit"
            onclick="editarLicencia(${index})"
            title="Editar"
          >
            ✏️
          </button>
          <button
            type="button"
            class="btn-action btn-delete"
            onclick="eliminarLicencia(${index})"
            title="Eliminar"
          >
            🗑️
          </button>
        </div>
      </td>
    </tr>
  `
      )
      .join("");
  }

  // ==============================
  // Función para abrir el modal
  // ==============================
  function abrirModal(esNuevo = true, index = -1) {
    const modal = document.getElementById("modalLicencia");
    const titulo = document.getElementById("modalTitulo");
    const form = document.getElementById("formLicencia");

    indiceEdicion = index;

    if (esNuevo) {
      titulo.textContent = "Nueva Licencia";
      form.reset();
      document.getElementById("codigo").value = `LIC-${String(
        contadorCodigo
      ).padStart(3, "0")}`;
      document.getElementById("fecha").valueAsDate = new Date();
      document.getElementById("valorTotal").value = "$0.00";
    } else {
      titulo.textContent = "Editar Licencia";
      const licencia = licencias[index];
      document.getElementById("codigo").value = licencia.codigo;
      document.getElementById("nombre").value = licencia.nombre;
      document.getElementById("descripcion").value = licencia.descripcion;
      document.getElementById("fecha").value = licencia.fechaInput;
      document.getElementById("cantidad").value = licencia.cantidad;
      document.getElementById("precio").value = licencia.precio;
      document.getElementById(
        "valorTotal"
      ).value = `$${licencia.valorTotal.toFixed(2)}`;
    }

    modal.style.display = "flex";
  }

  // ==============================
  // Función para cerrar el modal
  // ==============================
  function cerrarModal() {
    document.getElementById("modalLicencia").style.display = "none";
    document.getElementById("formLicencia").reset();
    indiceEdicion = -1;
  }

  // ==============================
  // Función para calcular valor total en el modal
  // ==============================
  function calcularValorTotalModal() {
    const cantidad = parseFloat(document.getElementById("cantidad").value) || 0;
    const precio = parseFloat(document.getElementById("precio").value) || 0;
    const valorTotal = cantidad * precio;
    document.getElementById("valorTotal").value = `$${valorTotal.toFixed(2)}`;
  }

  // ==============================
  // Función para guardar licencia
  // ==============================
  function guardarLicencia() {
    const codigo = document.getElementById("codigo").value;
    const nombre = document.getElementById("nombre").value.trim();
    const descripcion =
      document.getElementById("descripcion").value.trim() || "Sin descripción";
    const fechaInput = document.getElementById("fecha").value;
    const cantidad = parseInt(document.getElementById("cantidad").value) || 0;
    const precio = parseFloat(document.getElementById("precio").value) || 0;

    if (!nombre) {
      alert("El nombre de la licencia es obligatorio.");
      return;
    }

    if (!fechaInput) {
      alert("La fecha es obligatoria.");
      return;
    }

    const fecha = new Date(fechaInput + "T00:00:00").toLocaleDateString(
      "es-ES"
    );
    const valorTotal = cantidad * precio;

    const licencia = {
      codigo,
      nombre,
      descripcion,
      fecha,
      fechaInput,
      cantidad,
      precio,
      valorTotal,
    };

    if (indiceEdicion >= 0) {
      licencias[indiceEdicion] = licencia;
      alert("¡Licencia actualizada exitosamente!");
    } else {
      licencias.push(licencia);
      contadorCodigo++;
      alert("¡Licencia agregada exitosamente!");
    }

    renderizarTabla();
    calcularTotales();
    cerrarModal();
  }

  // ==============================
  // Función para editar licencia
  // ==============================
  function editarLicencia(index) {
    abrirModal(false, index);
  }

  // ==============================
  // Función para eliminar licencia
  // ==============================
  function eliminarLicencia(index) {
    const licencia = licencias[index];

    if (
      confirm(
        `¿Está seguro que desea eliminar la licencia "${licencia.nombre}"?`
      )
    ) {
      licencias.splice(index, 1);
      renderizarTabla();
      calcularTotales();
      alert("¡Licencia eliminada exitosamente!");
    }
  }

  // ==============================
  // Función de búsqueda
  // ==============================
  function buscarLicencias() {
    const busqueda = document.getElementById("buscar").value.toLowerCase();
    const filas = document.querySelectorAll("#tableLicencias tr");

    filas.forEach((fila) => {
      const texto = fila.textContent.toLowerCase();
      if (texto.includes(busqueda)) {
        fila.style.display = "";
      } else {
        fila.style.display = "none";
      }
    });
  }

  // ==============================
  // Función para guardar cambios
  // ==============================
  function guardarCambios() {
    if (licencias.length === 0) {
      alert("No hay licencias para guardar.");
      return;
    }

    console.log("Licencias a guardar:", licencias);
    alert("¡Cambios guardados exitosamente!");
  }

  // ==============================
  // Inicialización
  // ==============================
  document.addEventListener("DOMContentLoaded", function () {
    // Botón Nueva Licencia
    document
      .getElementById("btnNuevaLicencia")
      .addEventListener("click", () => abrirModal(true));

    // Botones del modal
    document
      .getElementById("btnCerrarModal")
      .addEventListener("click", cerrarModal);
    document
      .getElementById("btnCancelar")
      .addEventListener("click", cerrarModal);
    document
      .getElementById("btnGuardarLicencia")
      .addEventListener("click", guardarLicencia);

    // Cerrar modal al hacer clic fuera
    document
      .getElementById("modalLicencia")
      .addEventListener("click", function (e) {
        if (e.target === this) {
          cerrarModal();
        }
      });

    // Calcular valor total automáticamente
    document
      .getElementById("cantidad")
      .addEventListener("input", calcularValorTotalModal);
    document
      .getElementById("precio")
      .addEventListener("input", calcularValorTotalModal);

    // Botón Guardar
    document
      .getElementById("btnGuardar")
      .addEventListener("click", guardarCambios);

    // Input de búsqueda
    document
      .getElementById("buscar")
      .addEventListener("input", buscarLicencias);

    // Inicializar totales
    calcularTotales();
  });
</script>

{% endblock %}
